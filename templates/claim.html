<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É Solana Web3.js -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f0f2f5; }
        .container { text-align: center; background-color: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 400px; }
        h1 { color: #1c1e21; }
        p { color: #606770; font-size: 16px; }
        button { background-color: #1877f2; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.3s; margin-top: 20px;}
        button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #166fe5; }
        #status { margin-top: 20px; font-weight: bold; }
        #status a { color: #1877f2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>–ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥</h1>
        <p>–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã—Ö –Ω–∞–≥—Ä–∞–¥ –∑–∞ —Å—Ç–µ–π–∫–∏–Ω–≥, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ –∏ –ø–æ–¥–ø–∏—à–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é.</p>
        
        <button id="connectButton">–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫</button>
        <button id="claimButton" disabled>üí∞ –ü–æ–ª—É—á–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—ã</button>

        <div id="status"></div>
        <p id="walletBalance" style="margin-top: 12px;"></p>
    </div>

    <script>
        // --- –û–°–ù–û–í–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        const connectButton = document.getElementById('connectButton');
        const claimButton = document.getElementById('claimButton');
        const statusDiv = document.getElementById('status');
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —à–∞–±–ª–æ–Ω–∞
        const userWallet = "{{ user_wallet }}";
        const telegramId = "{{ tg_id }}";
        const ownerWallet = "{{ owner_wallet }}";
        const mintAddress = "{{ mint_address }}";
        const programId = "{{ program_id }}";
        const assocTokenProgramId = "{{ assoc_token_program_id }}";

        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
        const PROGRAM_ID = new solanaWeb3.PublicKey(programId);
        const TOKEN_MINT_ADDRESS = new solanaWeb3.PublicKey(mintAddress);
        const ASSOCIATED_TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey(assocTokenProgramId);
        const TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA");
        const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'), 'confirmed');

        let provider;
        let connectedWalletPubkey;

        // --- –õ–û–ì–ò–ö–ê –†–ê–ë–û–¢–´ ---

        window.addEventListener('load', async () => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ Phantom –∫–æ—à–µ–ª–µ–∫
            if ('solana' in window && window.solana.isPhantom) {
                provider = window.solana;
            } else {
                statusDiv.innerHTML = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ Phantom –∏–ª–∏ Solflare.";
                connectButton.disabled = true;
            }
        });

        connectButton.addEventListener('click', async () => {
            try {
                const resp = await provider.connect();
                connectedWalletPubkey = resp.publicKey;
                statusDiv.innerHTML = `–ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω: <br>${connectedWalletPubkey.toBase58().substring(0, 6)}...`;
                connectButton.style.display = 'none';
                claimButton.disabled = false;

                // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–π –∫–æ—à–µ–ª–µ–∫ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–º, —á—Ç–æ –≤ –±–æ—Ç–µ
                if (connectedWalletPubkey.toBase58() !== userWallet) {
                    statusDiv.innerHTML = `<b>–û—à–∏–±–∫–∞:</b> –ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–π –∫–æ—à–µ–ª–µ–∫ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–æ—à–µ–ª—å–∫–æ–º –∏–∑ Telegram.`;
                    claimButton.disabled = true;
                    document.getElementById('walletBalance').textContent = '';
                    return;
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å (–¥–µ–º–æ)
                document.getElementById('walletBalance').innerHTML = `–ë–∞–ª–∞–Ω—Å: <b>2,34</b> SDCB`;
            } catch (err) {
                statusDiv.textContent = `–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${err.message}`;
            }
        });

        claimButton.addEventListener('click', async () => {
            if (!provider || !connectedWalletPubkey) {
                statusDiv.textContent = '–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫.';
                return;
            }
            
            statusDiv.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏...';

            try {
                // 1. –ù–∞—Ö–æ–¥–∏–º PDA –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ
                const [lockPda, _] = await solanaWeb3.PublicKey.findProgramAddress(
                    [Buffer.from("lock"), connectedWalletPubkey.toBuffer()],
                    PROGRAM_ID
                );

                // 2. –ù–∞—Ö–æ–¥–∏–º ATA –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userAta = await solanaWeb3.PublicKey.findProgramAddress(
                    [
                        connectedWalletPubkey.toBuffer(),
                        TOKEN_PROGRAM_ID.toBuffer(),
                        TOKEN_MINT_ADDRESS.toBuffer()
                    ],
                    ASSOCIATED_TOKEN_PROGRAM_ID
                );

                // 3. –ù–∞—Ö–æ–¥–∏–º ATA –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–ª—è –∫–æ–º–∏—Å—Å–∏–∏
                let ownerAta;
                if (ownerWallet) {
                    const ownerPubkey = new solanaWeb3.PublicKey(ownerWallet);
                    ownerAta = await solanaWeb3.PublicKey.findProgramAddress(
                        [
                            ownerPubkey.toBuffer(),
                            TOKEN_PROGRAM_ID.toBuffer(),
                            TOKEN_MINT_ADDRESS.toBuffer()
                        ],
                        ASSOCIATED_TOKEN_PROGRAM_ID
                    );
                } else {
                    // –ï—Å–ª–∏ –∞–¥—Ä–µ—Å –≤–ª–∞–¥–µ–ª—å—Ü–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ –∞–¥—Ä–µ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    ownerAta = userAta;
                }

                // 4. –ù–∞—Ö–æ–¥–∏–º mint authority (–æ–±—ã—á–Ω–æ PDA –ø—Ä–æ–≥—Ä–∞–º–º—ã)
                const [mintAuthority, _bump] = await solanaWeb3.PublicKey.findProgramAddress(
                    [Buffer.from("mint_authority")],
                    PROGRAM_ID
                );

                // 5. –°–æ–∑–¥–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
                const instructionData = Buffer.alloc(1);
                instructionData.writeUInt8(2, 0); // –ò–Ω–¥–µ–∫—Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ ClaimRewards

                const instruction = new solanaWeb3.TransactionInstruction({
                    keys: [
                        { pubkey: connectedWalletPubkey, isSigner: true, isWritable: false },
                        { pubkey: lockPda, isSigner: false, isWritable: true },
                        { pubkey: userAta[0], isSigner: false, isWritable: true },
                        { pubkey: ownerAta[0], isSigner: false, isWritable: true },
                        { pubkey: TOKEN_MINT_ADDRESS, isSigner: false, isWritable: true },
                        { pubkey: mintAuthority, isSigner: false, isWritable: false },
                        { pubkey: TOKEN_PROGRAM_ID, isSigner: false, isWritable: false },
                        { pubkey: solanaWeb3.SYSVAR_CLOCK_PUBKEY, isSigner: false, isWritable: false },
                    ],
                    programId: PROGRAM_ID,
                    data: instructionData,
                });

                // 6. –°–æ–∑–¥–∞–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                const transaction = new solanaWeb3.Transaction().add(instruction);
                transaction.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;
                transaction.feePayer = connectedWalletPubkey;

                statusDiv.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–ø–∏—à–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ –≤–∞—à–µ–º –∫–æ—à–µ–ª—å–∫–µ...';
                
                const { signature } = await provider.signAndSendTransaction(transaction);
                
                statusDiv.innerHTML = `–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –û–∂–∏–¥–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è...<br><a href="https://explorer.solana.com/tx/${signature}?cluster=mainnet-beta" target="_blank">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ —ç–∫—Å–ø–ª–æ—Ä–µ—Ä–µ</a>`;

                // –°–æ–æ–±—â–∞–µ–º backend –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                try {
                    await fetch('/tx_callback', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tg_id: telegramId, signature, action: 'claim' })
                    });
                } catch (err) { console.error('callback error', err); }

                await connection.confirmTransaction(signature);

                statusDiv.innerHTML = `‚úÖ –£—Å–ø–µ—à–Ω–æ! –ù–∞–≥—Ä–∞–¥—ã –ø–æ–ª—É—á–µ–Ω—ã.<br><a href="https://explorer.solana.com/tx/${signature}?cluster=mainnet-beta" target="_blank">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ —ç–∫—Å–ø–ª–æ—Ä–µ—Ä–µ</a>`;
                claimButton.disabled = true;

            } catch (error) {
                console.error(error);
                statusDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
            }
        });
    </script>
</body>
</html> 
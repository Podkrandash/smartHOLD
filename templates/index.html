<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É Solana Web3.js -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f0f2f5; }
        .container { text-align: center; background-color: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 400px; }
        h1 { color: #1c1e21; }
        p { color: #606770; font-size: 16px; }
        button { background-color: #1877f2; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.3s; margin-top: 20px;}
        button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #166fe5; }
        #status { margin-top: 20px; font-weight: bold; }
        #status a { color: #1877f2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–º–æ—Ä–æ–∑–∫–∏</h1>
        <p>–î–ª—è –∑–∞–º–æ—Ä–æ–∑–∫–∏ <strong>{{ amount_display }} SDCB</strong> –Ω–∞ –∫–æ—à–µ–ª—å–∫–µ <strong>{{ user_wallet[:6] }}...{{ user_wallet[-4:] }}</strong>, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ –∏ –ø–æ–¥–ø–∏—à–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é.</p>
        
        <button id="connectButton">–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫</button>
        <button id="lockButton" disabled>üîí –ó–∞–º–æ—Ä–æ–∑–∏—Ç—å —Ç–æ–∫–µ–Ω—ã</button>

        <div id="status"></div>
    </div>

    <script>
        // --- –û–°–ù–û–í–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        const connectButton = document.getElementById('connectButton');
        const lockButton = document.getElementById('lockButton');
        const statusDiv = document.getElementById('status');
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ URL, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ Jinja2
        const userWallet = "{{ user_wallet }}";
        const amountToLock = BigInt("{{ amount or 0 }}");
        const telegramId = "{{ tg_id }}";

        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–∑ –Ω–∞—à–µ–≥–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –∏ —Å–µ—Ç–∏
        const PROGRAM_ID = new solanaWeb3.PublicKey("8cSiKf4CX2gxSyvvWmNZRxRifqX7GUXHzwE3b1jmzfX4");
        const TOKEN_MINT_ADDRESS = new solanaWeb3.PublicKey("AKzCnZFRTab25UuN2iLTzgjoeDxJuBLCXZwchFTkAbWz");
        const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'), 'confirmed');
        const ASSOCIATED_TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey("{{ assoc_token_program_id }}");

        let provider;
        let connectedWalletPubkey;

        // --- –õ–û–ì–ò–ö–ê –†–ê–ë–û–¢–´ ---

        window.addEventListener('load', async () => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ Phantom –∫–æ—à–µ–ª–µ–∫
            if ('solana' in window && window.solana.isPhantom) {
                provider = window.solana;
            } else {
                statusDiv.innerHTML = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ Phantom –∏–ª–∏ Solflare.";
                connectButton.disabled = true;
            }
        });

        connectButton.addEventListener('click', async () => {
            try {
                const resp = await provider.connect();
                connectedWalletPubkey = resp.publicKey;
                statusDiv.innerHTML = `–ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω: <br>${connectedWalletPubkey.toBase58().substring(0, 6)}...`;
                connectButton.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                lockButton.disabled = false; // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–º–æ—Ä–æ–∑–∫–∏

                // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–π –∫–æ—à–µ–ª–µ–∫ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–º, —á—Ç–æ –≤ –±–æ—Ç–µ
                if (connectedWalletPubkey.toBase58() !== userWallet) {
                    statusDiv.innerHTML = `<b>–û—à–∏–±–∫–∞:</b> –ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–π –∫–æ—à–µ–ª–µ–∫ (${connectedWalletPubkey.toBase58().substring(0,4)}...)<br>–Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–æ—à–µ–ª—å–∫–æ–º –∏–∑ Telegram (${userWallet.substring(0,4)}...).<br>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ—à–µ–ª–µ–∫.`;
                    lockButton.disabled = true;
                }
            } catch (err) {
                statusDiv.textContent = `–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${err.message}`;
            }
        });

        lockButton.addEventListener('click', async () => {
            if (!provider || !connectedWalletPubkey) {
                statusDiv.textContent = '–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫.';
                return;
            }
            
            statusDiv.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏...';

            try {
                // 1. –ù–∞—Ö–æ–¥–∏–º PDA –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ (—Ç–∞ –∂–µ –ª–æ–≥–∏–∫–∞, —á—Ç–æ –∏ –≤ Python)
                const [lockPda, _] = await solanaWeb3.PublicKey.findProgramAddress(
                    [Buffer.from("lock"), connectedWalletPubkey.toBuffer()],
                    PROGRAM_ID
                );

                // 2. –ù–∞—Ö–æ–¥–∏–º Associated Token Account (ATA) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userAta = await solanaWeb3.PublicKey.findProgramAddress(
                    [
                        connectedWalletPubkey.toBuffer(),
                        new solanaWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA").toBuffer(),
                        TOKEN_MINT_ADDRESS.toBuffer()
                    ],
                    ASSOCIATED_TOKEN_PROGRAM_ID
                );

                // 3. –ù–∞—Ö–æ–¥–∏–º Associated Token Account –¥–ª—è PDA (–∫—É–¥–∞ –ø–µ—Ä–µ–≤–µ–¥–µ–º —Ç–æ–∫–µ–Ω—ã)
                const pdaAta = await solanaWeb3.PublicKey.findProgramAddress(
                    [
                        lockPda.toBuffer(),
                        new solanaWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA").toBuffer(),
                        TOKEN_MINT_ADDRESS.toBuffer()
                    ],
                    ASSOCIATED_TOKEN_PROGRAM_ID
                );

                // 4. –°–æ–∑–¥–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
                // Instruction data: 8 –±–∞–π—Ç –¥–ª—è amount. –ü–µ—Ä–≤—ã–π –±–∞–π—Ç `0` - —ç—Ç–æ –∏–Ω–¥–µ–∫—Å –Ω–∞—à–µ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ LockTokens
                const instructionData = Buffer.alloc(9);
                instructionData.writeUInt8(0, 0); // –ò–Ω–¥–µ–∫—Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
                instructionData.writeBigUInt64LE(amountToLock, 1); // –°—É–º–º–∞

                const instruction = new solanaWeb3.TransactionInstruction({
                    keys: [
                        { pubkey: connectedWalletPubkey, isSigner: true, isWritable: false },
                        { pubkey: lockPda, isSigner: false, isWritable: true },
                        { pubkey: userAta[0], isSigner: false, isWritable: true },
                        { pubkey: pdaAta[0], isSigner: false, isWritable: true },
                        { pubkey: connectedWalletPubkey, isSigner: false, isWritable: false }, // authority
                        { pubkey: new solanaWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"), isSigner: false, isWritable: false },
                        { pubkey: solanaWeb3.SYSVAR_RENT_PUBKEY, isSigner: false, isWritable: false },
                        { pubkey: solanaWeb3.SYSVAR_CLOCK_PUBKEY, isSigner: false, isWritable: false },
                    ],
                    programId: PROGRAM_ID,
                    data: instructionData,
                });

                // 4. –°–æ–∑–¥–∞–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                const transaction = new solanaWeb3.Transaction().add(instruction);
                transaction.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;
                transaction.feePayer = connectedWalletPubkey;

                statusDiv.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–ø–∏—à–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ –≤–∞—à–µ–º –∫–æ—à–µ–ª—å–∫–µ...';
                
                const { signature } = await provider.signAndSendTransaction(transaction);
                
                statusDiv.innerHTML = `–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –û–∂–∏–¥–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è...<br><a href="https://explorer.solana.com/tx/${signature}?cluster=mainnet-beta" target="_blank">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ —ç–∫—Å–ø–ª–æ—Ä–µ—Ä–µ</a>`;

                // –°–æ–æ–±—â–∞–µ–º backend –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
                try {
                    await fetch('/tx_callback', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tg_id: telegramId, signature })
                    });
                } catch (err) { console.error('callback error', err); }

                await connection.confirmTransaction(signature);

                statusDiv.innerHTML = `‚úÖ –£—Å–ø–µ—à–Ω–æ! –¢–æ–∫–µ–Ω—ã –∑–∞–º–æ—Ä–æ–∂–µ–Ω—ã.<br><a href="https://explorer.solana.com/tx/${signature}?cluster=mainnet-beta" target="_blank">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ —ç–∫—Å–ø–ª–æ—Ä–µ—Ä–µ</a>`;
                lockButton.disabled = true;

            } catch (error) {
                console.error(error);
                statusDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
            }
        });
    </script>
</body>
</html> 